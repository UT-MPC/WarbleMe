<html>
    <head>
        <title>Warble Demo</title>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            var tcnv;
            var canvasWidth=800, canvasHeight=400;
            var ctx;
            var lastX, lastY, mouse_press=false;
            var savedCanvas;

            var trajectory={};

            function bodyInit() {
                tcnv = document.getElementById("TrajectoryCanvas");
                tcnv.setAttribute('width', canvasWidth);
                tcnv.setAttribute('height', canvasHeight);
                trajectory['width'] = canvasWidth;
                trajectory['height'] = canvasHeight;
                trajectory['trajectory'] = [];
                ctx = tcnv.getContext("2d");

                tcnv.addEventListener('mousedown', function (e) {
                    lastX = e.pageX - $(this).offset().left;
                    lastY = e.pageY - $(this).offset().top;
                    mouse_press = true;
                });

                tcnv.addEventListener('mousemove', function (e) {
                    var toX = e.pageX - $(this).offset().left;
                    var toY = e.pageY - $(this).offset().top;
                    if (mouse_press) {
                        draw(lastX, toX, lastY, toY);
                        trajectory['trajectory'].push(Math.floor(toX) + ',' + (tcnv.height - Math.floor(toY)));
                    }
                    lastX = toX;
                    lastY = toY;
                });

                tcnv.addEventListener('mouseup', function (e) {
                    lastX = null;
                    lastY = null;
                    mouse_press = false;
                });

                tcnv.addEventListener('mouseout', function (e) {
                    lastX = null;
                    lastY = null;
                    mouse_press = false;
                });

                tcnv.addEventListener('touchstart', function (e) {
                    if (e.touches) {
                        var touch = e.touches[0];
                        lastX = touch.pageX - touch.target.offsetLeft;
                        lastY = touch.pageY - touch.target.offsetTop;
                        window.blockMenuHeaderScroll = true;
                        e.preventDefault();
                    }
                });

                tcnv.addEventListener('touchmove', function (e) {
                    if (e.touches) {
                        var touch = e.touches[0];
                        var toX = touch.pageX - touch.target.offsetLeft;
                        var toY = touch.pageY - touch.target.offsetTop;
                        draw(lastX, toX, lastY, toY);
                        trajectory['trajectory'].push(Math.floor(toX) + ',' + (tcnv.height - Math.floor(toY)));
                        lastX = toX;
                        lastY = toY;
                    }
                });

                tcnv.addEventListener('touchend', function (e) {
                    lastX = null;
                    lastY = null;
                    window.blockMenuHeaderScroll = false;
                    $(this).trigger('submit');
                });
            }

            function draw(fromX, toX, fromY, toY) {
                ctx.beginPath();
                ctx.strokeStyle = 'red';
                ctx.lineWidth = '1';
                ctx.lineJoin = 'round';
                ctx.moveTo(fromX, fromY);
                ctx.lineTo(toX, toY);
                ctx.closePath();
                ctx.stroke();
            }

            function clearCanvas() {
                ctx.clearRect(0, 0, tcnv.width, tcnv.height);
                trajectory['trajectory'] = [];
            }

            function saveCanvas() {
                savedCanvas = tcnv.toDataURL('image/png');

                var downloadButton = document.getElementById('download-trajectory-image');
                downloadButton.setAttribute('href', savedCanvas)
            }

            function downloadTrajectory() {
                var trajectoryJson = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(trajectory));

                var downloadButton = document.getElementById('download-trajectory');
                downloadButton.setAttribute('href', trajectoryJson);
            }

            function saveTrajectory() {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/save');
                xhr.setRequestHeader('Content-type', 'application/json');
                xhr.send(JSON.stringify(trajectory));
            }

        </script>
    </head>

    <body onload="bodyInit()">
        <h1 class="text-center">Warble Demo</h1>

        <div class="container text-center">
            <p>Draw your trajectory here</p>
            <canvas id="TrajectoryCanvas" style="border: 2px solid;"></canvas>
        </div>

        <div class="container text-center">
            <a id="download-trajectory-image" download="trajectory.png"><button onclick="saveCanvas()" style="margin: 10px 5px 10px 5px">Save Image</button></a>
            <a id="download-trajectory" download="trajectory.json"><button onclick="downloadTrajectory()" style="margin: 10px 5px 10px 5px">Download JSON</button></a>
            <button onclick="saveTrajectory()" style="margin: 10px 5px 10px 5px">Save Trajectory</button>
            <button onclick="clearCanvas()" style="margin: 10px 5px 10px 5px">Clear</button>
        </div>
    </body>
</html>
